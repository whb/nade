<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>网络攻防演练监控屏幕</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <!--[if lte IE 8]><meta http-equiv="refresh" content="0;url=/ie" /><![endif]-->
  
  <link rel="stylesheet" href="/static/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="/static/css/animate.min.css"/>
  <link rel="stylesheet" href="/static/css/main.css">
  
  <script src="/static/js/echarts.min.js"></script>
  <script src="/static/js/map/china.js"></script> 
  <script src="/static/js/jquery-3.2.1.min.js"></script> 
  <script src="/static/js/bootstrap.min.js"></script>
</head>

<body class="container-fluid">
    <div class="col-md-12">
      <div class="row">
        <div id="main" style="height:1080px;"></div>
      </div>
    </div>
    
    <div class="col-md-6 screenshot_column">
      <div id="screenshot_pic"></div>
    </div>

    <div class="col-md-3 text_column" >
      <div class="intro">
      <h2><span class="label label-primary">3</span> 页面篡改攻击</h2>
      <p>天津某基础电信企业官网主页出现虚假信息，官网后台服务器遭受过口令破解攻击进而导致官网页面被篡改，攻击端IP来自河北某基础电信企业。  </p>
      </div>
      
      <div id="alarm" class="alarm"></div>
      
      <div id="defense" class="defense"> </div>
    </div>
    
<div id="alarmModal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <h1 class="alarm"><i class="fa fa-exclamation-triangle fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;警报（Ⅱ级）</h1>
        <h1>发现网页篡改！</h1>
      </div>
    </div>
</div>


<div id="alarmModal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <h1 class="alarm"><i class="fa fa-exclamation-triangle fa-lg" aria-hidden="true"></i>&nbsp;&nbsp;警报（Ⅱ级）</h1>
        <h1>发现网页篡改！</h1>
      </div>
    </div>
</div>
</body>

<script src="/static/js/main.js"></script> 
<script type="text/javascript">
var TextWidget = {
	createNew: function(parentDiv){
    	var widget = {};
    	widget.parent = parentDiv;
    	widget.type = parentDiv.attr('id');

    	(function(){ 
    	  widget.title = $('<h2 id="'+widget.type+'_title"></h2>').appendTo(widget.parent);
    	  widget.text = $('<h3 id="'+widget.type+'_text"></h3>').appendTo(widget.parent);
    	  widget.list = $('<ul id="'+widget.type+'_list"></ul>').appendTo(widget.parent);
    	})();
    	
    	widget.pageStatus = {};
    	
    	widget.getTitleIcon = function() {
          switch (widget.pageStatus.status) {
          case 'attack':
            return '<i class="fa fa-rocket"></i>';
          case 'alarm':
            return '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" t="1504312598649" class="svg replaced-svg" style="" viewBox="0 0 1024 1024" version="1.1" p-id="7807" width="48" height="48" id="alarm-light"><defs><style type="text/css"></style></defs><path d="M508.402 322.048c-124.401 0-225.258 100.835-225.258 225.236v276.754h453.721V547.284c0-124.402-100.834-225.236-225.236-225.236h-3.227z m-261.506 134.9c4-19.862-8.886-39.202-28.748-43.202l-106.22-21.316c-19.862-3.977-39.225 8.908-43.202 28.77a37.06 37.06 0 0 0-0.317 12.75c2.25 14.817 13.522 27.317 29.066 30.452l106.22 21.316c19.884 3.978 39.224-8.885 43.201-28.77z m-24.34-246.098l67.656 84.608c12.657 15.817 35.747 18.386 51.587 5.728 15.817-12.659 18.385-35.749 5.727-51.588l-67.677-84.587c-12.635-15.816-35.725-18.385-51.565-5.749-10.636 8.5-15.272 21.681-13.363 34.225a36.306 36.306 0 0 0 7.636 17.363z m292.05 31.999c20.271 0.477 37.066-15.568 37.542-35.816l-0.25-108.312c0.478-20.249-15.567-37.066-35.815-37.543-20.272-0.477-37.089 15.568-37.567 35.816l0.25 108.31c-0.045 2.183 0.091 4.342 0.41 6.433 2.636 17.27 17.363 30.702 35.43 31.112z m169.875 66.404c15.205 13.386 38.407 11.91 51.793-3.295l71.564-81.335c13.386-15.227 11.908-38.407-3.295-51.793-15.227-13.386-38.407-11.908-51.793 3.295l-71.585 81.337c-7.455 8.476-10.296 19.43-8.727 29.792 1.248 8.227 5.316 16.068 12.043 22z m267.12 132.72c-3.046-20.045-21.77-33.817-41.793-30.75l-107.106 16.295c-20.045 3.045-33.816 21.748-30.772 41.793 3.046 20.043 21.772 33.815 41.816 30.77l107.084-16.316c20.044-3.045 33.815-21.75 30.77-41.793zM816.994 908.008c0 28.884-23.407 52.27-52.293 52.27H243.806c-28.886 0-52.293-23.386-52.293-52.27 0-28.884 23.407-52.27 52.293-52.27h520.896c28.886 0 52.293 23.386 52.293 52.27z" fill="#d81e06" p-id="7808"></path></svg>';
          case 'analyze':
            return '<i class="fa fa-search"></i>';
          case 'repair':
            return '<i class="fa fa-wrench"></i>';
          case 'defense':
            return '<i class="fa fa-shield"></i>';
          case 'confirm':
            return '<i class="fa fa-check"></i>';
          default:
            return '';
          }
        };
      
    	widget.displayTitle = function(){ 
    	  widget.text.hide();
    	  widget.list.hide();
    	  widget.title.html(widget.getTitleIcon() + ' ' + widget.pageStatus.title);
    	  widget.title.show();
          return widget.pageStatus.status == 'alarm' ? widget.title.animateCss('tada') : widget.title.animateCss('fadeIn');
    	};
    	
    	widget.displayText = function(){ 
    	  widget.text.hide();
    	  widget.text.html(widget.pageStatus.text);
          return widget.text.fadeIn(2000);
    	};
    	
    	widget.displayList = function(){ 
    	  widget.list.empty();
    	  widget.list.show();
    	  widget.pageStatus.text.forEach(function(text, index) {
            setTimeout(function() { 
                $('<li>'+text+'</li>').appendTo(widget.list).animateCss('flipInX'); 
                if (text === "更新应用服务器管理员口令") {
                  WebPage.alarmWidget.hide();
                } else if (text === "恢复被篡改的页面代码") {
                  WebPage.hideScreenshot();
                }
            }, index*3000);
          });
    	};
    	
    	widget.setPageStatus = function(pageStatus){ 
    	  widget.pageStatus = pageStatus;
    	  switch (widget.type) {
            case 'alarm':
              widget.pageStatus.title = pageStatus.alarm_title;
              widget.pageStatus.text = pageStatus.alarm_text;
              break;
            case 'defense':
              widget.pageStatus.title = pageStatus.defense_title;
              widget.pageStatus.text = pageStatus.defense_text;
              break;
            default:
              widget.pageStatus.title = '';
              widget.pageStatus.text = '';
              break;
            }
    	};
    	
    	widget.display = function(pageStatus){ 
    	  widget.setPageStatus(pageStatus);
    	  queue(function () {
            return widget.displayTitle().delay(1000);
          }, function () {
            if( Object.prototype.toString.call( widget.pageStatus.text ) === '[object Array]' ) {
            	return widget.displayList();
          	} else {
            	return widget.displayText();
          	}
          });
    	};
    	
    	widget.hide = function() { 
    	  widget.title.hide();
    	  widget.text.hide();
    	  widget.list.hide();
    	}
    	
    	return widget;
    }
};

;WebPage = {
  api : "/api/webpage.json",
  pageStatus : {
  	status: ''
  },
  activeGeo : {},
  
  attackChart : echarts.init(document.getElementById('main')),
  alarmModal  : $('#alarmModal'),
  alarmWidget : TextWidget.createNew($('#alarm')),
  defenseWidget : TextWidget.createNew($('#defense')),
  screenshotPic : $('#screenshot_pic'),
  
  screenshotUrl : function() {
    return '<img src="/static/images/' + this.pageStatus.screenshot + '" width="100%" height="100%"/>';
  },
  
  popupAlarmModal : function() {
    this.alarmModal.modal('show');
  },
  
  displayScreenshot : function(delayTime) {
    this.screenshotPic.hide();
    this.screenshotPic.html(this.screenshotUrl());
    return this.screenshotPic.delay(delayTime).slideDown(4000);
  },
  
  hideScreenshot : function() {
    this.screenshotPic.fadeOut(1000);
  },
  
  hideAll : function() {
    alarmWidget.hide()
    defenseWidget.hide()
    $('#screenshot_pic').fadeOut(1000);
  },

  redrawChart : function() {
    moveOption.series[0].data = buildAttackLines();
    moveOption.series[1].data = buildAttackLines();
    moveOption.series[2].data = buildAreaScatter();
    moveOption.series[2].markPoint.data = buildDefenseMarkPoint();
    moveOption.series[3].data = buildDefensingLines();
    moveOption.series[4].data = buildDefensingLines();
    moveOption.geo = buildZoomCenter();
    this.attackChart.setOption(moveOption);
  },
  
 
  attack : function() {
    this.alarmWidget.display(this.pageStatus);
    this.activeGeo = {
      zoom: 4,
      center: geoCoordMap[this.pageStatus.attackArea]
    };
    setTimeout(function() { WebPage.redrawChart(); }, 2000);
  },
  
  alarm : function() {
    queue(function () {
      $('#alarmModal').modal('show');
      return $('#alarmModal').delay(3000);
    }, function () {
      $('#alarmModal').modal('hide');
      return WebPage.alarmWidget.display(WebPage.pageStatus); 
    }, function () {
      return WebPage.displayScreenshot(4000);       
    });
  },
  
  analyze : function() {
    WebPage.defenseWidget.display(WebPage.pageStatus); 
  },
  
  repair : function() {
    WebPage.defenseWidget.display(WebPage.pageStatus); 
  },
  
  defense : function() {
    WebPage.defenseWidget.display(WebPage.pageStatus); 
    this.activeGeo = {
      zoom: 4,
      center: geoCoordMap[this.pageStatus.attackArea]
    };
    setTimeout(function() { WebPage.redrawChart(); }, 2000);
    setTimeout(function() { WebPage.defensed(); }, 6000);
  },
  
  defensed : function() {
    this.pageStatus.status= 'defensed';
    this.activeGeo = {};
    this.redrawChart();
  },
  
  confirm : function() {
    queue(function () {
      WebPage.defenseWidget.display(WebPage.pageStatus); 
    }, function () {
      return WebPage.displayScreenshot(1000);
    });
  },
  
  initial : function() {
    this.activeGeo = {};
    this.redrawChart();
    this.hideAll();
  },
}
</script> 
<script src="/echarts/webpage.js"></script> 
<script type="text/javascript">
function getJsonAndDraw() {
  $.getJSON(WebPage.api, function( result ) {
    if(WebPage.pageStatus.status == result.status) {
		return;
    }
    if(WebPage.pageStatus.status == 'defensed' && result.status == 'defense') {
  		return;
    }
    
    WebPage.pageStatus = result;
    
    switch(result.status) {
      case "attack":
        WebPage.attack();
        break;
      case "alarm":
        WebPage.alarm();
        break;
      case "analyze":
        WebPage.analyze();
        break;
      case "repair":
        WebPage.repair();
        break;
      case "defense":
        WebPage.defense();
        break;
      case "confirm":
        WebPage.confirm();
        break;
      default:
        WebPage.initial();
	  }
  });
}

getJsonAndDraw();
setInterval(getJsonAndDraw, 1000);

$(window).resize(function() {
  WebPage.attackChart.resize();
});
</script>
</html>
